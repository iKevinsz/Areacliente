generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Avaliacao {
  id          Int      @id @default(autoincrement())
  nota        Int
  comentario  String?
  empresaId   Int
  criadoEm    DateTime @default(now())
  clienteNome String   @default("Cliente Anônimo")
  resposta    String?
  tags        String?
  empresa     Empresa  @relation(fields: [empresaId], references: [id], map: "Avaliacao_empresaId_fkey")

  @@index([empresaId], map: "Avaliacao_empresaId_fkey")
  @@map("avaliacao")
}

model Caixa {
  id             Int       @id @default(autoincrement())
  empresaId      Int
  operador       String
  dataAbertura   DateTime  @default(now())
  dataFechamento DateTime?
  saldoInicial   Decimal   @default(0.00) @db.Decimal(10, 2)
  saldoFinal     Decimal?  @db.Decimal(10, 2)
  quebraDeCaixa  Decimal?  @default(0.00) @db.Decimal(10, 2) // Usado para cálculo de quebra
  status         String    @default("ABERTO") // ABERTO, FECHADO

  empresa Empresa @relation(fields: [empresaId], references: [id], map: "Caixa_empresaId_fkey")

  movimentos CaixaMovimento[]
  pedidos    Pedido[]

  @@index([empresaId], map: "Caixa_empresaId_fkey")
  @@map("caixa")
}

model CaixaMovimento {
  id             Int                   @id @default(autoincrement())
  caixaId        Int
  dataHora       DateTime?             @default(now()) @db.DateTime(0)
  tipo           caixa_movimentos_tipo // VENDA, SANGRIA, SUPRIMENTO
  descricao      String?               @db.VarChar(255)
  formaPagamento String?               @db.VarChar(50)
  valor          Decimal               @db.Decimal(10, 2)

  caixa Caixa @relation(fields: [caixaId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "caixa_movimentos_ibfk_1")

  @@index([caixaId], map: "caixaId")
  @@map("caixa_movimentos")
}

model Complemento {
  id        Int     @id @default(autoincrement())
  nome      String
  preco     Decimal @db.Decimal(10, 2)
  produtoId Int
  produto   Produto @relation(fields: [produtoId], references: [id], onDelete: Cascade, map: "Complemento_produtoId_fkey")

  @@index([produtoId], map: "Complemento_produtoId_fkey")
  @@map("complemento")
}

model ContaPagar {
  id           Int      @id @default(autoincrement())
  empresaId    Int
  descricao    String
  fornecedor   String?
  valor        Decimal  @db.Decimal(10, 2)
  vencimento   DateTime
  status       String   @default("pendente")
  categoria    String?
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  empresa      Empresa  @relation(fields: [empresaId], references: [id], map: "ContaPagar_empresaId_fkey")

  @@index([empresaId], map: "ContaPagar_empresaId_fkey")
  @@map("contapagar")
}

model ContaReceber {
  id           Int      @id @default(autoincrement())
  empresaId    Int
  descricao    String
  cliente      String?
  valor        Decimal  @db.Decimal(10, 2)
  vencimento   DateTime
  status       String   @default("pendente")
  categoria    String?
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  empresa      Empresa  @relation(fields: [empresaId], references: [id], map: "ContaReceber_empresaId_fkey")

  @@index([empresaId], map: "ContaReceber_empresaId_fkey")
  @@map("contareceber")
}

model Cupom {
  id           Int       @id @default(autoincrement())
  empresaId    Int
  codigo       String
  tipoDesconto String
  valor        Decimal   @db.Decimal(10, 2)
  minimoCompra Decimal   @default(0.00) @db.Decimal(10, 2)
  limiteUso    Int       @default(0)
  validade     DateTime?
  ativo        Boolean   @default(true)
  empresa      Empresa   @relation(fields: [empresaId], references: [id], onDelete: Cascade, map: "Cupom_empresaId_fkey")

  @@index([empresaId], map: "Cupom_empresaId_fkey")
  @@map("cupom")
}

model Empresa {
  id                Int     @id @default(autoincrement())
  cnpj              String  @unique(map: "Empresa_cnpj_key")
  email             String?
  bairro            String?
  categorias        String?
  celular           String?
  cep               String?
  cidade            String?
  complemento       String?
  contato           String?
  endereco          String?
  facebook          String?
  fusoHorario       String?
  ie                String?
  im                String?
  instagram         String?
  linkLoja          String?
  logo              String? @db.LongText
  nomeFantasia      String?
  numero            String?
  razaoSocial       String?
  segmento          String?
  site              String?
  telefone          String?
  telefoneComercial String?
  tempoEntrega      String?
  tempoEstimado     String?
  twitter           String?
  uf                String?
  whatsapp          String?
  youtube           String?
  calculoPreco      String  @default("media")
  cepObrigatorio    Boolean @default(false)
  configEntrega     Json?
  configPagamento   Json?
  cpfObrigatorio    Boolean @default(true)
  enviarWhatsapp    Boolean @default(true)
  lojaFechada       Boolean @default(false)
  ocultarCardapio   Boolean @default(false)
  valorMinimo       Decimal @default(0.00) @db.Decimal(10, 2)

  // Relações
  avaliacoes            Avaliacao[]
  caixas                Caixa[]
  contasPagar           ContaPagar[]
  contasReceber         ContaReceber[]
  cupons                Cupom[]
  excecoesFrete         ExcecaoFrete[]
  fluxoCaixa            FluxoCaixa[]
  grupos                Grupo[]
  horariosFuncionamento HorarioFuncionamento[]
  pausas                Pausa[]
  regrasFrete           RegraFrete[]

  @@map("empresa")
}

model ExcecaoFrete {
  id        Int     @id @default(autoincrement())
  empresaId Int
  cep       String
  valor     Decimal @db.Decimal(10, 2)
  empresa   Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade, map: "ExcecaoFrete_empresaId_fkey")

  @@index([empresaId], map: "ExcecaoFrete_empresaId_fkey")
  @@map("excecaofrete")
}

model FluxoCaixa {
  id        Int      @id @default(autoincrement())
  empresaId Int
  descricao String
  tipo      String
  categoria String?
  valor     Decimal  @db.Decimal(10, 2)
  data      DateTime
  status    String   @default("Confirmado")
  empresa   Empresa  @relation(fields: [empresaId], references: [id])

  criadoEm DateTime @default(now())

  @@index([empresaId], map: "FluxoCaixa_empresaId_fkey")
  @@map("fluxocaixa")
}

model Grupo {
  id        Int     @id @default(autoincrement())
  nome      String
  empresaId Int
  ativo     Boolean @default(true)
  ordem     Int     @default(0)
  empresa   Empresa @relation(fields: [empresaId], references: [id], map: "Grupo_empresaId_fkey")

  // CORREÇÃO: Grupo tem GrupoVariacao e GrupoComplemento
  complementos GrupoComplemento[]
  variacoes    GrupoVariacao[]

  produtos Produto[]

  @@index([empresaId], map: "Grupo_empresaId_fkey")
  @@map("grupo")
}

model GrupoComplemento {
  id          Int     @id @default(autoincrement())
  nome        String
  preco       Decimal @db.Decimal(10, 2)
  maxQtd      Int     @default(1)
  obrigatorio Boolean @default(false)
  grupoId     Int
  grupo       Grupo   @relation(fields: [grupoId], references: [id], onDelete: Cascade, map: "GrupoComplemento_grupoId_fkey")

  @@index([grupoId], map: "GrupoComplemento_grupoId_fkey")
  @@map("grupocomplemento")
}

model GrupoVariacao {
  id      Int    @id @default(autoincrement())
  nome    String
  grupoId Int
  grupo   Grupo  @relation(fields: [grupoId], references: [id], onDelete: Cascade, map: "GrupoVariacao_grupoId_fkey")

  @@index([grupoId], map: "GrupoVariacao_grupoId_fkey")
  @@map("grupovariacao")
}

model HorarioFuncionamento {
  id        Int     @id @default(autoincrement())
  empresaId Int
  dia       String
  diaIndex  Int
  ativo     Boolean @default(true)
  inicio    String?
  fim       String?
  empresa   Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade, map: "HorarioFuncionamento_empresaId_fkey")

  @@index([empresaId], map: "HorarioFuncionamento_empresaId_fkey")
  @@map("horariofuncionamento")
}

model ItemPedido {
  id         Int     @id @default(autoincrement())
  quantidade Int
  precoUnit  Decimal @db.Decimal(10, 2)
  pedidoId   Int
  produtoId  Int
  pedido     Pedido  @relation(fields: [pedidoId], references: [id], map: "ItemPedido_pedidoId_fkey")
  produto    Produto @relation(fields: [produtoId], references: [id], map: "ItemPedido_produtoId_fkey")

  @@index([pedidoId], map: "ItemPedido_pedidoId_fkey")
  @@index([produtoId], map: "ItemPedido_produtoId_fkey")
  @@map("itempedido")
}

model Pausa {
  id        Int      @id @default(autoincrement())
  empresaId Int
  nome      String
  inicio    DateTime
  fim       DateTime
  empresa   Empresa  @relation(fields: [empresaId], references: [id], onDelete: Cascade, map: "Pausa_empresaId_fkey")

  @@index([empresaId], map: "Pausa_empresaId_fkey")
  @@map("pausa")
}

model Pedido {
  id      Int          @id @default(autoincrement())
  cliente String?
  tipo    String
  status  String       @default("Pendente")
  total   Decimal      @db.Decimal(10, 2)
  data    DateTime     @default(now())
  caixaId Int?
  itens   ItemPedido[]
  caixa   Caixa?       @relation(fields: [caixaId], references: [id], map: "Pedido_caixaId_fkey")
  nfe     Nfe?

  @@index([caixaId], map: "Pedido_caixaId_fkey")
  @@map("pedido")
}

model Produto {
  id                 Int      @id @default(autoincrement())
  nome               String
  descricao          String?  @db.Text
  preco              Decimal  @db.Decimal(10, 2)
  categoria          String?
  estoque            Int      @default(0)
  imagem             String?  @db.LongText
  ativo              Boolean  @default(true)
  grupoId            Int?
  criadoEm           DateTime @default(now())
  atualizadoEm       DateTime @updatedAt
  permiteComplemento Boolean  @default(false)
  visivelOnline      Boolean  @default(true)

  // Relações
  complementos Complemento[]
  itensPedido  ItemPedido[]
  grupo        Grupo?        @relation(fields: [grupoId], references: [id], map: "Produto_grupoId_fkey")

  // CORREÇÃO: Produto tem Variacoes, não GrupoVariacao
  variacoes Variacao[]

  @@index([grupoId], map: "Produto_grupoId_fkey")
  @@map("produto")
}

model RegraFrete {
  id         Int      @id @default(autoincrement())
  empresaId  Int
  tipo       String
  kmMin      Decimal? @db.Decimal(10, 2)
  kmMax      Decimal? @db.Decimal(10, 2)
  nomeBairro String?
  valor      Decimal  @db.Decimal(10, 2)
  empresa    Empresa  @relation(fields: [empresaId], references: [id], onDelete: Cascade, map: "RegraFrete_empresaId_fkey")

  @@index([empresaId], map: "RegraFrete_empresaId_fkey")
  @@map("regrafrete")
}

model Usuario {
  id       Int      @id @default(autoincrement())
  nome     String
  email    String   @unique(map: "Usuario_email_key")
  senha    String
  criadoEm DateTime @default(now())

  @@map("usuario")
}

model Variacao {
  id        Int     @id @default(autoincrement())
  nome      String
  preco     Decimal @db.Decimal(10, 2)
  produtoId Int
  produto   Produto @relation(fields: [produtoId], references: [id], onDelete: Cascade, map: "Variacao_produtoId_fkey")

  @@index([produtoId], map: "Variacao_produtoId_fkey")
  @@map("variacao")
}

enum caixa_movimentos_tipo {
  VENDA
  SANGRIA
  SUPRIMENTO
}

model Nfe {
  id       Int      @id @default(autoincrement())
  pedidoId Int      @unique
  chave    String?
  status   String // pendente, autorizada, erro, cancelada
  xml      String?  @db.LongText
  pdfUrl   String?
  criadoEm DateTime @default(now())

  pedido Pedido @relation(fields: [pedidoId], references: [id])

  @@map("nfe")
}

model Orcamento {
  id          Int             @id @default(autoincrement())
  cliente     String
  documento   String?
  dataEmissao DateTime        @default(now())
  validade    DateTime
  total       Float
  status      String          @default("pendente") // pendente, aprovado, rejeitado
  observacao  String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  itens       ItemOrcamento[]
}

model ItemOrcamento {
  id          Int       @id @default(autoincrement())
  produto     String
  qtd         Int
  valorUnit   Float
  total       Float
  
  orcamentoId Int
  orcamento   Orcamento @relation(fields: [orcamentoId], references: [id], onDelete: Cascade)
}

model Sugestao {
  id            Int      @id @default(autoincrement())
  data          String    
  descricao     String   
  observacoes   String    
  sistema       String
  classificacao String
  curtidas      Int      @default(0)
  status        String   @default("pendente") 

  @@map("sugestoes") // Nome da tabela no banco
}